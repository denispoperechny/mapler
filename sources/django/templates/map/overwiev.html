{% extends "map/views-manager.html" %}

{% block views-manager-child %}

<p>Map Overview</p>
<div id="map_canvas" style="width:800px; height:500px"></div>
<div id="point-editing-zone"></div>

<div id="previewPointHtmlData" style="display: none;">{{previewPointHtmlData}}</div>

<script type="text/javascript"
	src="http://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false">
</script>

<script type="text/javascript">
	var pointEditor = {
		showInfo: function (pointId) {
			var point = null;
			pointsData.forEach(function(entry) {
				if (entry.id == pointId)
					point = entry;
			});

			if (point == null)
				return;

			$( "div#point-editing-zone" ).html($( "div#previewPointHtmlData" ).html());

			$( "div#point-editing-zone" ).find( "#id_owner" ).html(point.owner);
			$( "div#point-editing-zone" ).find( "#id_creationDate" ).html(point.creationDate);
			$( "div#point-editing-zone" ).find( "#id_latitude" ).html(point.latitude);
			$( "div#point-editing-zone" ).find( "#id_longitude" ).html(point.longitude);
			$( "div#point-editing-zone" ).find( "#id_description" ).html(point.description);

		},
		clear: function() {
			$( "div#point-editing-zone" ).html('');
		}
	}
</script>

<script type="text/javascript">
	// To be filled on server side
	var pointsData = [] ;

	function loadPointsData(callback) {
		$.getJSON("/data/points/", function( data ) {
			pointsData = data;
			callback();
		});

	}

	function getPointOnClickCallback(pointId) {
		pointEditor.showInfo(pointId);
	}

	function getMapOnClickCallback(latitude, longitude) {
		pointEditor.clear();
	}

	function buildPoints(map, onPointClick) {
		pointsData.forEach(function(entry) {
			var id = entry.id;
			var lng = entry.longitude;
			var lat = entry.latitude;
			var title = entry.description;
			var owner = entry.owner;
			var creationDate = entry.creationDate;

			var marker = new google.maps.Marker({
				position: new google.maps.LatLng(lat, lng),
				map: map,
				title: owner + '\n' + creationDate + '\n' + title
			});
			marker.mapler_id = id;

			google.maps.event.addListener(marker, 'click', function() {
				//pointEditor.showEditor(marker.mapler_id);
				onPointClick(marker.mapler_id);
			});
    		
		});	  
	}

	function initialize() {
		var mapOptions = {
			center: new google.maps.LatLng(50.43, 30.56),
			zoom: 11,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		};
		var map = new google.maps.Map(document.getElementById("map_canvas"),
		mapOptions);

		google.maps.event.addListener(map, "click", function (event) {
		    var latitude = event.latLng.lat();
			var longitude = event.latLng.lng();

			getMapOnClickCallback(latitude, longitude);
		});

		loadPointsData(function() {
			buildPoints(map, getPointOnClickCallback);
		});
		
	}

	google.maps.event.addDomListener(window, 'load', initialize);
</script>


{% endblock views-manager-child %}