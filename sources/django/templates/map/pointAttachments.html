
<h3>Attachments</h3>

<table id="point_attachments_templates" style="display: none;">
	<tbody>
		<tr id="editable_template">
			<td><a href='%file_link%'>%file_name%</a></td>
			<td>%owner%</td>
			<td>%upload_date%</td>
			<td><a href='%delete_link%' ident="delLink">Delete</a></td>
		</tr>
		<tr id="readonly_template">
			<td><a href='%file_link%'>%file_name%</a></td>
			<td>%owner%</td>
			<td>%upload_date%</td>
		</tr>
	</tbody>
</table>

<table id="point_attachments" class="table table-striped table-bordered table-condensed">
	<tbody>
	</tbody>
</table>

<form id="pointAttachementsForm" action="/file/upload/" enctype="multipart/form-data" method="post">{% csrf_token %}
	<input type="hidden" name="pointId" value="-1">
	<input type="hidden" name="redirectTarget" value="">
	<input type="file" name="attachment" id="attachment" />
	<input type="submit" value="Upload" />
</form>

<script type="text/javascript">
var pointAttacmentsManager = {
	_pointId: '',
	_isEditable: false,
	_redirectTarget: '',
	_data: [],

	initialize: function(pointId, isEditable, redirectTarget) {
		pointAttacmentsManager._pointId = pointId;
		pointAttacmentsManager._isEditable = isEditable;
		pointAttacmentsManager._redirectTarget = redirectTarget;

		if (pointAttacmentsManager._isEditable) {
			$("#pointAttachementsForm").show();
		} else {
			$("#pointAttachementsForm").hide();
		}

		$("#pointAttachementsForm").find("input[name='pointId']").val(pointAttacmentsManager._pointId);
		$("#pointAttachementsForm").find("input[name='redirectTarget']").val(pointAttacmentsManager._redirectTarget);
		pointAttacmentsManager._loadData(pointAttacmentsManager._buildGuiItems);
	},

	_loadData: function(callback) {
		$.getJSON( "/data/point-attachments/"+pointAttacmentsManager._pointId+"/", function( data ) {
			pointAttacmentsManager._data = data;
			callback();
		});
	},

	_buildGuiItems: function() {
		var container = $("#point_attachments tbody");
		var recordTemplate = null;

		if (pointAttacmentsManager._isEditable) {
			recordTemplate = $("#point_attachments_templates tbody #editable_template").html();
		} else {
			recordTemplate = $("#point_attachments_templates tbody #readonly_template").html();
		}
		
		var newContent = "";
		
		container.html("");

		$.each( pointAttacmentsManager._data, function( index, value ) {
			newContent += "<tr>" + pointAttacmentsManager._fillAttachmentData(recordTemplate, value) + "</tr>";
		});

		container.html(newContent);

		// custom link handler here
		container.find("a[ident='delLink']").on("click", pointAttacmentsManager._onDelLinkClicked);
	},

	_reinitialize: function(){
		pointAttacmentsManager.initialize(pointAttacmentsManager._pointId, pointAttacmentsManager._isEditable, pointAttacmentsManager._redirectTarget);
	},

	_onDelLinkClicked: function(event) {
		var request = $(event.target).attr('href');
		$.ajax({
			url: request,
			success: function(){
				pointAttacmentsManager._reinitialize();
			}
		});
		event.preventDefault();
	},

	// onSubmit: function() {
	// 	var submitUrl = $("#pointAttachementsForm").attr("action");
		
	// 	$("#pointAttachementsForm").ajaxSubmit({
	// 		url: submitUrl, 
	// 		type: 'post',
	// 		success: function(responseData, status){
	// 			pointAttacmentsManager.initialize(pointAttacmentsManager._pointId, pointAttacmentsManager._isEditable);
	// 		}
	// 	});

	// 	//pointAttacmentsManager.initialize(pointAttacmentsManager._pointId, pointAttacmentsManager._isEditable);
	// },

	_fillAttachmentData: function(template, attchData) {
		return template
		.replace('%file_name%', attchData.fileName)
		.replace('%upload_date%', attchData.creationDate)
		.replace('%owner%', attchData.owner)
		.replace('%file_link%', '/static/media/' + attchData.id + '_' + attchData.fileName)
		.replace('%delete_link%', '/file/delete/' + attchData.id + '/');
	}
}

// $( "#pointAttachementsForm" ).submit(function( event ) {
//   pointAttacmentsManager.onSubmit();
//   event.preventDefault();
// });

</script>